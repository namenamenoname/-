<!DOCTYPE ahtml>
<html>
<head>
  <!-- Tailwind CSS CDN ë¡œë“œ -->
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      overflow: hidden; /* ì „ì²´ í˜ì´ì§€ ìŠ¤í¬ë¡¤ ë°©ì§€ */
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background-color: #e0f2fe; /* í•˜ëŠ˜ìƒ‰ ë°°ê²½ */
    }
    
    /* ê²Œì„ ì»¨í…Œì´ë„ˆ */
    #game-container {
      position: relative;
      width: 100%;
      max-width: 350px; /* í™”ë©´ ë„ˆë¹„ ì‚´ì§ ì¦ê°€ */
      margin: 0 auto;
    }

    /* ê·¸ë¦¬ë“œ (ì¹´ë©”ë¼ ë·°í¬íŠ¸) */
    #game-grid-container {
      position: relative;
      aspect-ratio: 1 / 1;
      border: 4px solid #1e3a8a;
      border-radius: 8px;
      background-color: #bae6fd; /* í•˜ëŠ˜ìƒ‰ (ì±„êµ´ëœ ê³µê°„) */
      touch-action: none;
      overflow: hidden;
    }
    #game-grid {
      display: grid;
      grid-template-columns: repeat(10, 1fr); 
      grid-template-rows: repeat(10, 1fr);
      height: 100%;
    }
    
    .block {
      cursor: pointer; 
      display: flex;
      justify-content: center;
      align-items: center;
      border: 1px solid rgba(0, 0, 0, 0.05);
      user-select: none;
      font-size: 1.2rem;
      position: relative;
      /* ë¸”ë¡ì´ ì±„êµ´ë˜ê±°ë‚˜ ì¬ìƒì„±ë  ë•Œ ê¹œë¹¡ì´ëŠ” íš¨ê³¼ ë°©ì§€ */
      transition: background-color 0.1s;
    }

    /* í”Œë ˆì´ì–´ */
    #player {
      position: absolute;
      width: 10%;
      height: 10%;
      background-color: #f59e0b; 
      border: 2px solid #fff;
      border-radius: 50%;
      z-index: 20;
      /* ë¶€ë“œëŸ¬ìš´ ì´ë™ ë° ë‚™í•˜ ì• ë‹ˆë©”ì´ì…˜ */
      transition: top 0.2s ease-in, left 0.1s linear; 
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.2rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* === ë¸”ë¡ ìŠ¤íƒ€ì¼ === */
    .grass { background-color: #65a30d; border-top: 4px solid #4d7c0f; } 
    .dirt { background-color: #78350f; }  
    .stone { background-color: #4b5563; } 
    
    /* ë‚˜ë¬´ (Tree) */
    .tree-log { background-color: #8b5c3b; }

    /* ì„íƒ„ (Coal) */
    .coal-ore { 
      background-color: #333;
      background-image: radial-gradient(#1f2937 25%, transparent 26%), radial-gradient(#1f2937 25%, transparent 26%);
      background-size: 12px 12px;
      background-position: 0 0, 6px 6px;
    }
    
    /* êµ¬ë¦¬ (Copper) - í”í•¨ */
    .copper-ore { 
        background-color: #5b211a; /* ì–´ë‘ìš´ êµ¬ë¦¬ ìƒ‰ */
        background-image: radial-gradient(#b91c1c 20%, transparent 21%), radial-gradient(#ef4444 20%, transparent 21%);
        background-size: 14px 14px;
        background-position: 0 0, 7px 7px;
    }

    /* ì²  (Iron) - ë³´í†µ */
    .iron-ore { 
        background-color: #4b5563; /* ëŒ ê¸°ë°˜ */
        background-image: radial-gradient(#d1d5db 18%, transparent 19%), radial-gradient(#9ca3af 18%, transparent 19%);
        background-size: 10px 10px;
        background-position: 0 0, 5px 5px;
    }

    /* ê¸ˆ (Gold) - í¬ê·€ */
    .gold-ore { 
        background-color: #4b5563; 
        background-image: radial-gradient(#fbbf24 18%, transparent 19%), radial-gradient(#f97316 18%, transparent 19%);
        background-size: 10px 10px;
        background-position: 0 0, 5px 5px;
        border: 2px solid #eab308;
    }

    /* ì—ë©”ë„ë“œ (Emerald) - ë§¤ìš° í¬ê·€ */
    .emerald-ore { 
        background-color: #1f2937; 
        background-image: radial-gradient(#10b981 12%, transparent 13%), radial-gradient(#059669 12%, transparent 13%);
        background-size: 10px 10px;
        background-position: 0 0, 5px 5px;
        border: 2px solid #047857;
    }

    /* ë‹¤ì´ì•„ëª¬ë“œ (Diamond) - ëª©í‘œ */
    .diamond-ore { 
      background-color: #1f2937; 
      background-image: radial-gradient(#60a5fa 15%, transparent 16%), radial-gradient(#3b82f6 15%, transparent 16%);
      background-size: 10px 10px;
      background-position: 0 0, 5px 5px;
      border: 2px solid #2563eb;
    }

    /* ì±„êµ´ëœ ìƒíƒœ (íˆ¬ëª…/ë°°ê²½ìƒ‰) */
    .mined {
      background-color: transparent !important;
      background-image: none !important;
      border: none !important;
    }
    .mined:hover {
      background-color: rgba(255, 255, 255, 0.2) !important;
    }

    /* ì˜¤ë²„ë ˆì´ (ìŠ¹ë¦¬/íŒ¨ë°° ë©”ì‹œì§€) */
    #overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 50;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      text-align: center;
    }
    .hidden { display: none !important; }
    
    .key-badge {
      display: inline-block;
      padding: 2px 6px;
      background-color: #e2e8f0;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: bold;
      color: #334155;
    }
  </style>
</head>
<body class="p-4" tabindex="0">

  <h1 class="text-xl font-bold mb-2 text-center text-blue-900">ğŸŒ 2D ì˜¤í”ˆì›”ë“œ ìƒì¡´ ê²Œì„ (ë¬´í•œ ì—ë„ˆì§€)</h1>
  
  <div id="game-container">
    
    <!-- ê²Œì„ í™”ë©´ -->
    <div id="game-grid-container" class="shadow-xl">
      <!-- ê²Œì„ ì˜¤ë²„/ìŠ¹ë¦¬ ì˜¤ë²„ë ˆì´ -->
      <div id="overlay" class="hidden">
        <h2 id="overlay-title" class="text-3xl font-bold mb-2">ê²Œì„ ì˜¤ë²„</h2>
        <p id="overlay-desc" class="mb-6 text-gray-300">ë‹¤ì´ì•„ëª¬ë“œë¥¼ ì°¾ì§€ ëª»í•˜ê³  íƒí—˜ì„ ë§ˆì³¤ìŠµë‹ˆë‹¤.</p>
        <button onclick="restartGame()" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 rounded-full font-bold transition text-white">
          ë‹¤ì‹œ ë„ì „í•˜ê¸°
        </button>
      </div>

      <!-- í”Œë ˆì´ì–´ -->
      <div id="player">ğŸ‘·</div>
      <!-- ê·¸ë¦¬ë“œ -->
      <div id="game-grid"></div>
    </div>
    
    <!-- ì•ˆë‚´ ë©”ì‹œì§€ -->
    <div class="text-xs text-center text-gray-600 mt-3 space-y-1">
      <p>
        <span class="key-badge">W</span> ì í”„ | 
        <span class="key-badge">A</span><span class="key-badge">D</span> ì´ë™ |
        í´ë¦­í•´ì„œ ì±„êµ´
      </p>
      <p class="text-blue-700 font-semibold">
        ğŸ’¡ íŒ: ë‚˜ë¬´ë¥¼ ì±„êµ´í•˜ê³ , ê¸ˆ, ì² , êµ¬ë¦¬, ì—ë©”ë„ë“œ ê´‘ë¬¼ì„ ì°¾ì•„ ê¹Šì´ íŒŒê³ ë“œì„¸ìš”!
      </p>
    </div>
    
    <p id="focus-message" class="text-xs text-center text-red-500 mt-2 font-semibold animate-pulse">
      âš ï¸ ì¡°ì‘ì´ ì•ˆë˜ë©´ í™”ë©´ì„ í´ë¦­í•˜ì„¸ìš”!
    </p>
  </div>

  <script>
    // Firebase ë° ê¸°íƒ€ ì™¸ë¶€ APIëŠ” ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™” ì½”ë“œëŠ” ìƒëµí•©ë‹ˆë‹¤.
    
    const GRID_SIZE = 10;
    const VIEWPORT_CENTER = Math.floor(GRID_SIZE / 2); // 5
    const gameGrid = document.getElementById('game-grid');
    const playerElement = document.getElementById('player');
    const overlay = document.getElementById('overlay');
    const overlayTitle = document.getElementById('overlay-title');
    const overlayDesc = document.getElementById('overlay-desc');
    const focusMessage = document.getElementById('focus-message');
    
    // ê²Œì„ ì„¤ì • (ì—ë„ˆì§€ ì‹œìŠ¤í…œ ì œê±° ìƒíƒœ ìœ ì§€)
    const COST_MOVE = 0; 
    const COST_JUMP = 0; 
    const COST_MINE = 0; 
    const HEAL_APPLE = 0; 
    const GRAVITY_SPEED = 1000; // ì¤‘ë ¥ ì²´í¬ ì†ë„ (ms)
    
    // ê²Œì„ ìƒíƒœ (ê¸€ë¡œë²Œ ì¢Œí‘œ ì‚¬ìš©)
    let playerGlobalX = 0; 
    let playerGlobalY = 0;
    let isGameOver = false;
    let gravityInterval;
    
    // ì›”ë“œ ë°ì´í„° ì €ì¥ì†Œ (Key: "x,y", Value: blockType)
    let minedBlocks = new Map();
    // NEW: ìƒì„±ëœ ë¸”ë¡ì˜ íƒ€ì…ì„ ì˜êµ¬ì ìœ¼ë¡œ ì €ì¥í•˜ëŠ” ìºì‹œ (ê´‘ë¬¼ ë° ëŒ ê³ ì •ìš©)
    let blockCache = new Map();
    // ë‹¤ì´ì•„ëª¬ë“œ ìœ„ì¹˜ ì €ì¥
    let diamondPosition = { x: 0, y: 0 };
    let isDiamondFound = false;

    // ë¸”ë¡ íƒ€ì… (ì¶”ê°€ëœ ê´‘ë¬¼ ë° ë‚˜ë¬´)
    const BLOCK_TYPES = {
      1: { name: 'ì”ë””', cssClass: 'grass', loot: 'grass', canDropApple: true },
      2: { name: 'í™', cssClass: 'dirt', loot: 'dirt', canDropApple: false },
      3: { name: 'ëŒ', cssClass: 'stone', loot: 'stone', canDropApple: false },
      4: { name: 'ë‹¤ì´ì•„ëª¬ë“œ', cssClass: 'diamond-ore', loot: 'diamond', isGoal: true },
      5: { name: 'ì„íƒ„', cssClass: 'coal-ore', loot: 'coal', isCommonOre: true },
      6: { name: 'ê¸ˆ', cssClass: 'gold-ore', loot: 'gold', isRareOre: true },
      7: { name: 'ì² ', cssClass: 'iron-ore', loot: 'iron', isMediumOre: true },
      8: { name: 'êµ¬ë¦¬', cssClass: 'copper-ore', loot: 'copper', isCommonOre: true },
      9: { name: 'ì—ë©”ë„ë“œ', cssClass: 'emerald-ore', loot: 'emerald', isVeryRareOre: true },
      10: { name: 'ë‚˜ë¬´', cssClass: 'tree-log', loot: 'wood', isSurface: true },
    };

    /**
     * íŠ¹ì • ê¸€ë¡œë²Œ ì¢Œí‘œì— ìˆëŠ” ë¸”ë¡ì˜ íƒ€ì…ì„ ê²°ì •í•©ë‹ˆë‹¤.
     * (ë¬´í•œ ì›”ë“œ ìƒì„± ë¡œì§ - ìˆœìˆ˜ ê³„ì‚°. Math.random()ì„ ì‚¬ìš©í•˜ì—¬ ë¸”ë¡ì„ ì²˜ìŒ ìƒì„±í•  ë•Œë§Œ í˜¸ì¶œë¨)
     * @param {number} gx ê¸€ë¡œë²Œ X ì¢Œí‘œ
     * @param {number} gy ê¸€ë¡œë²Œ Y ì¢Œí‘œ (ê¹Šì´)
     * @returns {number} ë¸”ë¡ íƒ€ì… ì¸ë±ìŠ¤ (0: ê³µê¸°, 1: ì”ë””, 2: í™, 3: ëŒ, 5~10: ê´‘ë¬¼/ë‚˜ë¬´)
     */
    function generateBlockType(gx, gy) {
      if (gy < 0) return 0; // í•˜ëŠ˜ (ë¸”ë¡ ì—†ìŒ)

      // X ì¢Œí‘œì— ë”°ë¥¸ ì§€í˜• ë†’ì´ ë³€ë™ (ì§€í‘œë©´ ê³„ì‚°)
      const surfaceOffset = Math.sin(gx / 5) * 2; // -2 to +2
      const baseSurfaceY = 5; // ê¸°ë³¸ ì§€í‘œë©´ ê¹Šì´
      const surfaceY = Math.round(baseSurfaceY + surfaceOffset); 

      // === ì§€ìƒ/ê³µê¸° ë¡œì§ ===
      if (gy < surfaceY - 1) {
          // ì§€í‘œë©´ ë°”ë¡œ ìœ„ (gy = surfaceY - 2)ì— 5% í™•ë¥ ë¡œ ë‚˜ë¬´ ìƒì„±
          if (gy === surfaceY - 2 && Math.random() < 0.05) {
              return 10; // ë‚˜ë¬´ (Tree Log)
          }
          return 0; // ë‚˜ë¨¸ì§€ ê³µê°„ì€ í•˜ëŠ˜ (ê³µê¸°)
      } else if (gy === surfaceY - 1) {
        return 1; // ì§€í‘œë©´ (ì”ë””)
      } else if (gy < surfaceY + 4) {
        return 2; // í™
      } else {
        // === ì§€í•˜ (ëŒ ë° ê´‘ë¬¼) ë¡œì§ (gy >= 6) ===
        // ì´ ë¡œì§ì€ ë¸”ë¡ì´ ì²˜ìŒ ìƒì„±ë  ë•Œë§Œ ì‹¤í–‰ë˜ë©°, ê²°ê³¼ëŠ” blockCacheì— ì €ì¥ë˜ì–´ ê³ ì •ë©ë‹ˆë‹¤.
        const rand = Math.random();
        
        // ê´‘ë¬¼ ìƒì„± í™•ë¥  (ë‚®ì€ í™•ë¥ ë¶€í„° ì²´í¬í•˜ì—¬ ì¤‘ë³µ ë°©ì§€)
        
        // 1. ì—ë©”ë„ë“œ (Type 9) - ë§¤ìš° í¬ê·€, ê¹Šì€ ê³³ (gy >= 25)
        if (gy >= 25 && rand < 0.005) return 9; // 0.5%
        
        // 2. ê¸ˆ (Type 6) - í¬ê·€ (gy >= 15)
        if (gy >= 15 && rand < 0.02) return 6; // 2%
        
        // 3. ì²  (Type 7) - ë³´í†µ (gy >= 10)
        if (gy >= 10 && rand < 0.05) return 7; // 5%

        // 4. êµ¬ë¦¬ (Type 8) - í”í•¨ (gy >= 6)
        if (rand < 0.08) return 8; // 8%

        // 5. ì„íƒ„ (Type 5) - ë§¤ìš° í”í•¨ (gy >= 6)
        if (rand < 0.15) return 5; // 15%

        return 3; // ëŒ (ê¸°ë³¸)
      }
    }
    
    /**
     * íŠ¹ì • ê¸€ë¡œë²Œ ì¢Œí‘œì˜ í˜„ì¬ ë¸”ë¡ ìƒíƒœ(íƒ€ì…, ì±„êµ´ ì—¬ë¶€)ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
     */
    function getBlockState(gx, gy) {
      const key = `${gx},${gy}`;
      
      // 1. ì´ë¯¸ ì±„êµ´ëœ ë¸”ë¡ì¸ì§€ í™•ì¸ (ê°€ì¥ ë†’ì€ ìš°ì„ ìˆœìœ„)
      if (minedBlocks.has(key)) {
        return { type: 0, isMined: true };
      }
      
      // 2. ë‹¤ì´ì•„ëª¬ë“œ ìœ„ì¹˜ í™•ì¸ (í•­ìƒ ë™ì¼)
      if (isDiamondFound === false && gx === diamondPosition.x && gy === diamondPosition.y) {
        return { type: 4, isMined: false, isGoal: true };
      }

      let type = 0;

      // 3. ìºì‹œ í™•ì¸ (ìƒì„±ëœ ë¸”ë¡ì„ ê³ ì •)
      if (blockCache.has(key)) {
          type = blockCache.get(key);
      } else {
          // 4. ìºì‹œì— ì—†ìœ¼ë©´ ì›”ë“œ ìƒì„± ë¡œì§ ì‹¤í–‰ (Math.random() í˜¸ì¶œ)
          type = generateBlockType(gx, gy);
          
          // 5. ê³µê¸°ê°€ ì•„ë‹Œ ê²½ìš° ìºì‹œì— ì €ì¥í•˜ì—¬ ê³ ì •
          if (type !== 0) {
              blockCache.set(key, type);
          }
      }

      if (type === 0) {
        // ê³µê¸° ë¸”ë¡ì´ê±°ë‚˜ ì›”ë“œ ìƒì„± ë¡œì§ìƒ ë¹ˆ ê³µê°„ì´ë©´ ì±„êµ´ëœ ê²ƒìœ¼ë¡œ ê°„ì£¼
        return { type: 0, isMined: true };
      }
      
      return { type: type, isMined: false };
    }

    /**
     * ê²Œì„ ì´ˆê¸°í™” ë° ì‹œì‘
     */
    function initGame() {
      // ì›”ë“œ ì´ˆê¸°í™”
      minedBlocks.clear();
      blockCache.clear(); // NEW: ë¸”ë¡ ìºì‹œ ì´ˆê¸°í™”
      isDiamondFound = false;
      
      // ë‹¤ì´ì•„ëª¬ë“œ ìœ„ì¹˜ ì„¤ì • (X: -50 ~ 50, Y: 15~20 ì‚¬ì´)
      diamondPosition.x = Math.floor(Math.random() * 101) - 50; 
      diamondPosition.y = Math.floor(Math.random() * 6) + 15; // ê¹Šì€ ê³³ì— ì„¤ì •
      
      // í”Œë ˆì´ì–´ ì´ˆê¸° ìœ„ì¹˜ (ì›”ë“œ ì¤‘ì•™ ìƒë‹¨)
      playerGlobalX = 0;
      playerGlobalY = 0; 

      // ì´ˆê¸° ì§€í‘œë©´ê¹Œì§€ ìë™ìœ¼ë¡œ ë–¨ì–´ì§€ê²Œ ì‹œì‘ ì§€ì  ì£¼ë³€ì„ ë¹„ì›Œì¤ë‹ˆë‹¤.
      for (let y = 0; y <= 5; y++) {
        minedBlocks.set(`${playerGlobalX},${y}`, 0);
      }
      
      isGameOver = false;
      overlay.classList.add('hidden');
      document.body.focus();
      
      renderWorld();
      
      // ì¤‘ë ¥ ë£¨í”„ ì‹œì‘
      if (gravityInterval) clearInterval(gravityInterval);
      gravityInterval = setInterval(applyGravity, GRAVITY_SPEED);
    }

    function restartGame() {
      initGame();
    }
    
    /**
     * í˜„ì¬ í”Œë ˆì´ì–´ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ 10x10 ì›”ë“œë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤ (ì¹´ë©”ë¼ ì‹œì ).
     */
    function renderWorld() {
      gameGrid.innerHTML = '';
      
      // ì¹´ë©”ë¼ ë·°í¬íŠ¸ì˜ ì¢Œì¸¡ ìƒë‹¨ ê¸€ë¡œë²Œ ì¢Œí‘œ ê³„ì‚°
      const viewGlobalX = playerGlobalX - VIEWPORT_CENTER;
      const viewGlobalY = playerGlobalY - VIEWPORT_CENTER;

      for (let i = 0; i < GRID_SIZE * GRID_SIZE; i++) {
        const viewportY = Math.floor(i / GRID_SIZE);
        const viewportX = i % GRID_SIZE;
        
        const gx = viewGlobalX + viewportX;
        const gy = viewGlobalY + viewportY;
        
        const state = getBlockState(gx, gy);
        const type = state.type;
        const isMined = state.isMined;
        const blockData = BLOCK_TYPES[type] || {};

        const blockElement = document.createElement('div');
        // ëª¨ë“  ë¸”ë¡ í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•˜ì—¬ ë™ì ìœ¼ë¡œ ìŠ¤íƒ€ì¼ë§
        blockElement.className = `block ${blockData.cssClass || ''} ${isMined ? 'mined' : ''}`;
        
        // ë¸”ë¡ì˜ ê¸€ë¡œë²Œ ì¢Œí‘œë¥¼ ë°ì´í„°ì…‹ì— ì €ì¥
        blockElement.dataset.gx = gx;
        blockElement.dataset.gy = gy;
        blockElement.dataset.typeIndex = type;
        
        blockElement.addEventListener('click', handleBlockClick);
        
        gameGrid.appendChild(blockElement);
      }
      
      // í”Œë ˆì´ì–´ì˜ í™”ë©´ ë‚´ ìœ„ì¹˜ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤ (ì¤‘ì•™ ê³ ì •)
      const blockPercent = 100 / GRID_SIZE; 
      playerElement.style.left = `${VIEWPORT_CENTER * blockPercent}%`;
      playerElement.style.top = `${VIEWPORT_CENTER * blockPercent}%`;
    }

    /**
     * ì¤‘ë ¥ ì ìš© í•¨ìˆ˜ (ì£¼ê¸°ì ìœ¼ë¡œ ì‹¤í–‰)
     */
    function applyGravity() {
      if (isGameOver) return;
      
      const blockBelow = getBlockState(playerGlobalX, playerGlobalY + 1);
        
      // ì•„ë˜ ì¹¸ì´ ì±„êµ´ëœ ìƒíƒœ(ë¹ˆ ê³µê°„)ë¼ë©´ ë–¨ì–´ì§
      if (blockBelow.isMined) {
        playerGlobalY++;
        renderWorld(); // ì›”ë“œ ì¬ë Œë”ë§
      }
    }

    function endGame(isWin) {
      isGameOver = true;
      clearInterval(gravityInterval); // ì¤‘ë ¥ ë©ˆì¶¤
      overlay.classList.remove('hidden');
      
      if (isWin) {
        overlayTitle.textContent = "ğŸ’ ë¯¸ì…˜ ì„±ê³µ! ğŸ’";
        overlayDesc.innerHTML = "ì „ì„¤ì˜ ë‹¤ì´ì•„ëª¬ë“œë¥¼ ìº¤ìŠµë‹ˆë‹¤!";
        overlayTitle.className = "text-3xl font-bold mb-2 text-yellow-400";
      } else {
        overlayTitle.textContent = "ğŸ’€ ê²Œì„ ì˜¤ë²„";
        overlayDesc.textContent = "íƒí—˜ì„ ë§ˆì³¤ìŠµë‹ˆë‹¤.";
        overlayTitle.className = "text-3xl font-bold mb-2 text-red-500";
      }
    }

    /**
     * ë¸”ë¡ ì‹œê°ì  ì±„êµ´ ì²˜ë¦¬ (DOMê³¼ Map ì—…ë°ì´íŠ¸)
     */
    function mineBlock(blockElement) { 
      const gx = parseInt(blockElement.dataset.gx);
      const gy = parseInt(blockElement.dataset.gy);
      const typeIndex = parseInt(blockElement.dataset.typeIndex);
      
      const key = `${gx},${gy}`;
      
      // 1. ì›”ë“œ ë°ì´í„° ì—…ë°ì´íŠ¸ (ì±„êµ´ ê¸°ë¡)
      minedBlocks.set(key, typeIndex);
      // NOTE: ìºì‹œì—ëŠ” ë‚¨ì•„ìˆì§€ë§Œ, minedBlocksê°€ ìš°ì„ ìˆœìœ„ê°€ ë†’ì•„ ë‹¤ìŒë¶€í„°ëŠ” ê³µê¸°ë¡œ ì²˜ë¦¬ë¨.
      
      // 2. ì‹œê°ì  ì—…ë°ì´íŠ¸
      // ëª¨ë“  ë¸”ë¡ í´ë˜ìŠ¤ë¥¼ ì œê±°í•˜ê³  mined í´ë˜ìŠ¤ë¥¼ ì¶”ê°€
      blockElement.classList.remove('grass', 'dirt', 'stone', 'diamond-ore', 'coal-ore', 'gold-ore', 'iron-ore', 'copper-ore', 'emerald-ore', 'tree-log'); 
      blockElement.classList.add('mined');
      blockElement.dataset.typeIndex = 0; // ì±„êµ´ë¨
    }

    /**
     * í‚¤ë³´ë“œ ì¡°ì‘ (ì í”„ ë° ì´ë™)
     */
    document.addEventListener('keydown', (event) => {
      if (isGameOver) return;
      focusMessage.classList.add('hidden');

      let newX = playerGlobalX;
      let isJump = false;

      switch (event.key) {
        case 'w': case 'ArrowUp': 
          isJump = true;
          break;
        case 's': case 'ArrowDown': 
          // ì•„ë˜ í‚¤ëŠ” ì¤‘ë ¥ìœ¼ë¡œ ì²˜ë¦¬ë˜ë¯€ë¡œ ì´ë™ ë°©ì§€
          return;
        case 'a': case 'ArrowLeft': newX--; break;
        case 'd': case 'ArrowRight': newX++; break;
        default: return;
      }

      // --- ì í”„ ë¡œì§ ---
      if (isJump) {
        const blockBelow = getBlockState(playerGlobalX, playerGlobalY + 1);
        
        // ë°”ë‹¥ì— ë‹¿ì•„ ìˆê±°ë‚˜ (ì•„ë˜ê°€ ì±„êµ´ë˜ì§€ ì•Šì€ ë¸”ë¡) ì›”ë“œ ê²½ê³„(ì•„ë˜)ê°€ ì•„ë‹ˆì–´ì•¼ ì í”„ ê°€ëŠ¥
        if (blockBelow.isMined === false) {
          const blockAbove = getBlockState(playerGlobalX, playerGlobalY - 1);
          
          // ìœ„ìª½ ê³µê°„ í™•ì¸ (ë¨¸ë¦¬ ë¶€ë”ªí˜ ë°©ì§€)
          if (blockAbove.isMined === true) {
            playerGlobalY--; // ì í”„!
            renderWorld();
          }
        }
        return;
      }

      // --- ì¢Œìš° ì´ë™ ë¡œì§ (A/D) ---
      const targetBlock = getBlockState(newX, playerGlobalY); // YëŠ” í˜„ì¬ ìœ„ì¹˜ ìœ ì§€

      if (targetBlock.isMined === false) {
        // ë²½ì´ ë§‰í˜€ìˆìŒ -> ëª» ê° (ì‹œê°ì  í”¼ë“œë°± ì œê³µ)
        const playerViewportIndex = VIEWPORT_CENTER * GRID_SIZE + VIEWPORT_CENTER;
        const playerBlock = gameGrid.children[playerViewportIndex];
        
        if (playerBlock) {
          playerBlock.style.transform = 'scale(0.95)';
          setTimeout(() => playerBlock.style.transform = 'scale(1)', 100);
        }
        return;
      }

      // 3. ì´ë™ ìˆ˜í–‰
      playerGlobalX = newX;
      
      renderWorld(); // ì´ë™ í›„ ë·°í¬íŠ¸ ì—…ë°ì´íŠ¸
      
      // ì´ë™ í›„ ì¦‰ì‹œ ì¤‘ë ¥ì„ ì ìš©í•˜ì—¬ ì ˆë²½ì—ì„œ ë–¨ì–´ì§€ê²Œ ë§Œë“­ë‹ˆë‹¤.
      applyGravity(); 
    });

    /**
     * ë§ˆìš°ìŠ¤/í„°ì¹˜ ì±„êµ´ ë¡œì§
     */
    function handleBlockClick(event) {
      if (isGameOver) return;
      document.body.focus();
      focusMessage.classList.add('hidden');

      const blockElement = event.target;
      if (!blockElement.classList.contains('block')) return;
      
      const gx = parseInt(blockElement.dataset.gx);
      const gy = parseInt(blockElement.dataset.gy);

      // 1. ì±„êµ´ ëŒ€ìƒ ë¸”ë¡ì´ ì´ë¯¸ ì±„êµ´ë˜ì—ˆëŠ”ì§€ í™•ì¸
      if (getBlockState(gx, gy).isMined) return;

      // 2. ê±°ë¦¬ ê³„ì‚° (í”Œë ˆì´ì–´ ì£¼ë³€ 1ì¹¸, ëŒ€ê°ì„  í¬í•¨)
      const dx = Math.abs(playerGlobalX - gx);
      const dy = Math.abs(playerGlobalY - gy);
      
      if (dx <= 1 && dy <= 1) {
        // ë‹¤ì´ì•„ëª¬ë“œ?
        if (gx === diamondPosition.x && gy === diamondPosition.y) {
          mineBlock(blockElement);
          isDiamondFound = true;
          endGame(true);
          return;
        }

        // ì¼ë°˜ ì±„êµ´ (ìƒˆë¡œìš´ ê´‘ë¬¼/ë‚˜ë¬´ í¬í•¨)
        mineBlock(blockElement);
        // ì±„êµ´ í›„ ì¦‰ì‹œ ì¤‘ë ¥ì„ ì ìš©í•˜ì—¬ í”Œë ˆì´ì–´ê°€ ë–¨ì–´ì§ˆ ìˆ˜ ìˆê²Œ í™•ì¸
        applyGravity(); 
        
      } else {
        // ë„ˆë¬´ ë¨¼ ê³³
        blockElement.style.outline = '2px solid red';
        setTimeout(() => blockElement.style.outline = 'none', 200);
      }
    }
    
    // ê²Œì„ ì‹œì‘
    window.onload = initGame;
  </script>
</body>
</html>
